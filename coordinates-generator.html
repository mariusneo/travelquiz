<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <title>Travel Quiz Coordinates Generator</title>
    <style>
        #drop{
        border:2px dashed #bbb;
        -moz-border-radius:5px;
        -webkit-border-radius:5px;
        border-radius:5px;
        padding:25px;
        text-align:center;
        font:20pt bold,"Vollkorn";color:#bbb
        }
    </style>
</head>
<h1>Travel Quiz Coordinates Generator</h1><br />

<p>This page is to be used to generate the content of travelquiz/js/coordinates.js</p>
<p>When the generation of the coordinates is successful, replace the generated coordinates.js file with the
    <b>travelquiz/js/coordinates.js</b> file from <b>travelquiz</b> installation folder.</p>

<p>Note that the <b>coordinates.xls</b> file has to have the following format : </p>

<table border="1" width="800px">
    <thead>
        <tr>
            <td>image</td>
            <td>lat</td>
            <td>lng</td>
            <td>description</td>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td>CIMG2276.JPG</td>
            <td>3.174373</td>
            <td>101.703716</td>
            <td>Istana Budaya am Lake Titiwangsa, Kuala Lumpur</td>
        </tr>
        <tr>
            <td>CIMG2281.JPG</td>
            <td>3.139003</td>
            <td>101.686855</td>
            <td></td>
        </tr>
    </tbody>
</table>

<p>The description column in the table above is optional and does not necessarily need to be filled.</p>
<p>It is recommended not to leave empty lines between the rows that are filled in order to ]
    avoid problems when parsing the Excel file.</p>

<div id="drop">Drop the coordinates.xls file here</div>
<form>
<p><input type="file" name="xlfile" id="xlf" /> ... or click here to select the coordinates.xls file</p>
</form>

<input type="checkbox" style="display:none" name="useworker" checked><br />
<input type="checkbox" style="display:none" name="xferable" checked><br />
<input type="checkbox" style="display:none" name="userabs" checked><br />
<textarea xmlns="http://www.w3.org/1999/xhtml"  id="out"
          style="width:700px;height:300px;"
          placeholder="Preview of the generated coordinates.js file"></textarea>
<br />
<!-- uncomment the next line here and in xlsxworker.js for encoding support -->
<!--<script src="dist/cpexcel.js"></script>-->
<script src="js/js-xlsx/shim.js"></script>
<script src="js/js-xlsx/jszip.js"></script>
<script src="js/js-xlsx/xlsx.js"></script>
<script src="js/js-xlsx/ods.js"></script>
<script src="js/jquery-1.11.1.js"></script>
<script src="js/filesaver/FileSaver.js"></script>
<script>
var X = XLSX;
var XW = {
	/* worker message */
	msg: 'xlsx',
	/* worker scripts */
	rABS: 'js/js-xlsx/xlsxworker2.js',
	norABS: 'js/js-xlsx/xlsxworker1.js',
	noxfer: 'js/js-xlsx/xlsxworker.js'
};

var rABS = typeof FileReader !== "undefined" && typeof FileReader.prototype !== "undefined" && typeof FileReader.prototype.readAsBinaryString !== "undefined";
if(!rABS) {
	document.getElementsByName("userabs")[0].disabled = true;
	document.getElementsByName("userabs")[0].checked = false;
}

var use_worker = typeof Worker !== 'undefined';
if(!use_worker) {
	document.getElementsByName("useworker")[0].disabled = true;
	document.getElementsByName("useworker")[0].checked = false;
}

var transferable = use_worker;
if(!transferable) {
	document.getElementsByName("xferable")[0].disabled = true;
	document.getElementsByName("xferable")[0].checked = false;
}

var wtf_mode = false;

function fixdata(data) {
	var o = "", l = 0, w = 10240;
	for(; l<data.byteLength/w; ++l) o+=String.fromCharCode.apply(null,new Uint8Array(data.slice(l*w,l*w+w)));
	o+=String.fromCharCode.apply(null, new Uint8Array(data.slice(l*w)));
	return o;
}

function ab2str(data) {
	var o = "", l = 0, w = 10240;
	for(; l<data.byteLength/w; ++l) o+=String.fromCharCode.apply(null,new Uint16Array(data.slice(l*w,l*w+w)));
	o+=String.fromCharCode.apply(null, new Uint16Array(data.slice(l*w)));
	return o;
}

function s2ab(s) {
	var b = new ArrayBuffer(s.length*2), v = new Uint16Array(b);
	for (var i=0; i != s.length; ++i) v[i] = s.charCodeAt(i);
	return [v, b];
}

function xw_noxfer(data, cb) {
	var worker = new Worker(XW.noxfer);
	worker.onmessage = function(e) {
		switch(e.data.t) {
			case 'ready': break;
			case 'e': console.error(e.data.d); break;
			case XW.msg: cb(JSON.parse(e.data.d)); break;
		}
	};
	var arr = rABS ? data : btoa(fixdata(data));
	worker.postMessage({d:arr,b:rABS});
}

function xw_xfer(data, cb) {
	var worker = new Worker(rABS ? XW.rABS : XW.norABS);
	worker.onmessage = function(e) {
		switch(e.data.t) {
			case 'ready': break;
			case 'e': console.error(e.data.d); break;
			default: xx=ab2str(e.data).replace(/\n/g,"\\n").replace(/\r/g,"\\r"); console.log("done"); cb(JSON.parse(xx)); break;
		}
	};
	if(rABS) {
		var val = s2ab(data);
		worker.postMessage(val[1], [val[1]]);
	} else {
		worker.postMessage(data, [data]);
	}
}

function xw(data, cb) {
	transferable = document.getElementsByName("xferable")[0].checked;
	if(transferable) xw_xfer(data, cb);
	else xw_noxfer(data, cb);
}

function get_radio_value( radioName ) {
	var radios = document.getElementsByName( radioName );
	for( var i = 0; i < radios.length; i++ ) {
		if( radios[i].checked || radios.length === 1 ) {
			return radios[i].value;
		}
	}
}

function to_json(workbook) {
    // export the content of the first worksheet to JSON
	var result = X.utils.sheet_to_row_object_array(workbook.Sheets[workbook.SheetNames[0]], {'raw':true});
    result.forEach(function(entry) {
        entry.lat = Number(entry.lat);
        entry.lng = Number(entry.lng);
    });
	return result;
}


function process_wb(wb) {
	var output ='(function() {\n'+
    '    window.getCoordList = function() {\n'+
    '        return ' + JSON.stringify(to_json(wb), 2, 2)+ ';\n'+
    '    };\n'+
    '})();';
	if(out.innerText === undefined) out.textContent = output;
	else out.innerText = output;
	var coordinatesBlob = new Blob([output], {type: "text/plain;charset=utf-8"});
    saveAs(coordinatesBlob, "coordinates.js");
}

var drop = document.getElementById('drop');
function handleDrop(e) {
	e.stopPropagation();
	e.preventDefault();
	rABS = document.getElementsByName("userabs")[0].checked;
	use_worker = document.getElementsByName("useworker")[0].checked;
	var files = e.dataTransfer.files;
	var f = files[0];
	{
		var reader = new FileReader();
		var name = f.name;
		reader.onload = function(e) {
			if(typeof console !== 'undefined') console.log("onload", new Date(), rABS, use_worker);
			var data = e.target.result;
			if(use_worker) {
				xw(data, process_wb);
			} else {
				var wb;
				if(rABS) {
					wb = X.read(data, {type: 'binary'});
				} else {
				var arr = fixdata(data);
					wb = X.read(btoa(arr), {type: 'base64'});
				}
				process_wb(wb);
			}
		};
		if(rABS) reader.readAsBinaryString(f);
		else reader.readAsArrayBuffer(f);
	}
}

function handleDragover(e) {
	e.stopPropagation();
	e.preventDefault();
	e.dataTransfer.dropEffect = 'copy';
}

if(drop.addEventListener) {
	drop.addEventListener('dragenter', handleDragover, false);
	drop.addEventListener('dragover', handleDragover, false);
	drop.addEventListener('drop', handleDrop, false);
}


var xlf = document.getElementById('xlf');
function handleFile(e) {
	rABS = document.getElementsByName("userabs")[0].checked;
	use_worker = document.getElementsByName("useworker")[0].checked;
	var files = e.target.files;
	var f = files[0];
	{
		var reader = new FileReader();
		var name = f.name;
		reader.onload = function(e) {
			if(typeof console !== 'undefined') console.log("onload", new Date(), rABS, use_worker);
			var data = e.target.result;
			if(use_worker) {
				xw(data, process_wb);
			} else {
				var wb;
				if(rABS) {
					wb = X.read(data, {type: 'binary'});
				} else {
				var arr = fixdata(data);
					wb = X.read(btoa(arr), {type: 'base64'});
				}
				process_wb(wb);
			}
		};
		if(rABS) reader.readAsBinaryString(f);
		else reader.readAsArrayBuffer(f);
	}
	$(xlf).wrap('<form>').closest('form').get(0).reset();
    $(xlf).unwrap();
}

if(xlf.addEventListener) xlf.addEventListener('change', handleFile, false);
</script>
</body>
</html>
